<!DOCTYPE html>
<html lang="en" class="dark-gray bg-white sans-serif lh-copy">
<title>Using MRTG again... - OpenBSD Amsterdam</title>
<meta charset="UTF-8">
<meta name="generator" content="romanzolotarev.com/ssg">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="discountegg" content="OBSD-EGG-2020">
<link rel="icon" type="image/png" href="/favicon.png">
<link rel="stylesheet" href="/style.css">
<body class="mw7 w-100 center pa3">
<div class="cf">
<div class="fl w-100 w-50-l w-50-m"><a href="/" title="OpenBSD Amsterdam Logo"><img class="w3 br-100" src="/images/logo.png" alt="OpenBSD Amsterdam Logo"></a></div>
<div class="fl w-100 w-50-l w-50-m mt2 tr"><a href="servers.html">370 VMs deployed</a>&nbsp;&#x1F421;</div>
</div>
<h1 id="Using%20MRTG%20again...">Using MRTG again...</h1>

<p class="f7">March 05, 2019</p>

<p>For <a href="https://openbsd.amsterdam/">OpenBSD Amsterdam</a> we were looking for a lightweight method to keep track of, at least, traffic and CPU load generated by the <a href="https://man.openbsd.org/vmm.4">vmm(4)</a>&#47;<a href="https://man.openbsd.org/vmd.8">vmd(8)</a> hosts.</p>

<p>We had some experience with Observium, which doesn&#39;t run well on <a href="https://openbsd.org/">OpenBSD</a>, and LibreNMS.
For some reason we were unable to get LibreNMS working on 6.4 nor on -current (6.5), so we decided to look elsewhere.</p>

<p>Considering our needs and what is available on <a href="https://openbsd.org/">OpenBSD</a> we decided to go back in time and have a look at <a href="https://oss.oetiker.ch/mrtg/">MRTG</a> again.</p>

<p>Getting <a href="https://oss.oetiker.ch/mrtg/">MRTG</a> working with <a href="https://man.openbsd.org/snmpd.8">OpenBSD</a> and collecting traffic is not a very big deal, <a href="https://oss.oetiker.ch/mrtg/doc/cfgmaker.en.html">cfgmaker</a> is your friend! Getting CPU load was more of a challenge.</p>

<p>First we had to figure out what the SNMP OID were for the CPU, as the default ones, in the <a href="https://oss.oetiker.ch/mrtg/">MRTG</a> documentation didn&#39;t cover them. We also had to consider the multi-core machines we are running.</p>

<p>After some digging in the MIBS we found &#39;hrProcessorLoad&#39; in &#47;usr&#47;local&#47;share&#47;mibs&#47;HOST-RESOURCES-MIB.txt.</p>

<pre><code>$ snmpctl snmp walk &#60;host&#62; community &#60;string&#62; oid hrProcessorLoad
hrProcessorLoad.1=24
hrProcessorLoad.2=57
hrProcessorLoad.3=33
hrProcessorLoad.4=26
hrProcessorLoad.5=21
hrProcessorLoad.6=25
hrProcessorLoad.7=77
hrProcessorLoad.8=68
hrProcessorLoad.9=61
hrProcessorLoad.10=54
hrProcessorLoad.11=24
hrProcessorLoad.12=50
hrProcessorLoad.13=0
hrProcessorLoad.14=0
hrProcessorLoad.15=0
hrProcessorLoad.16=0
hrProcessorLoad.17=0
hrProcessorLoad.18=0
hrProcessorLoad.19=0
hrProcessorLoad.20=0
hrProcessorLoad.21=0
hrProcessorLoad.22=0
hrProcessorLoad.23=0
hrProcessorLoad.24=0
</code></pre>

<p>With some Startpage&#47;DuckDuckGo-fu we stumbled upon a script that pulled a specific OID and ran some calculations on the CPU load based on the total number of cores and the sum of the load across these cores.</p>

<p>Here is the heavily modified version of that script.</p>

<pre><code>#!&#47;bin&#47;sh
test -n &#34;$1&#34; || exit 1
HOST=&#34;$1&#34;
CPUINFO=&#34;&#47;tmp&#47;cpuinfo.${HOST}&#34;

snmpctl walk ${HOST} oid hrProcessorLoad | cut -d= -f2 &#62; ${CPUINFO}
CORES=$(grep -cv &#34;^0$&#34; ${CPUINFO})
CPU_LOAD_SUM=$(awk &#39;{sum += $1} END {print sum}&#39; ${CPUINFO})
CPU_LOAD=$(echo &#34;scale=2; ${CPU_LOAD_SUM}&#47;${CORES}&#34; | bc -l)
echo &#34;$CPU_LOAD&#34;
echo &#34;$CPU_LOAD&#34;
</code></pre>

<p>It reads all the CPU information from the host and writes the load of each core in a temporary file in &#47;tmp. The cores are counted and the sum is calculated. Since <a href="https://undeadly.org/cgi?action=article;sid=20180824024934">SMT &#47; Hyper Threading</a> is off by default, we excluded the cores which are not taking any load.</p>

<p><a href="https://oss.oetiker.ch/mrtg/">MRTG</a> expects two values, it primairily operates in inbound and outbound traffic, we print the <code>$CPU_LOAD</code> twice. Job done! Not quite...
It also expects the uptime to be presented in a readable format as well as the hostname.</p>

<p>So... TimeTicks here we come!
To collect the uptime of an OpenBSD machine we need to query <code>hrSystemUptime</code>.</p>

<pre><code>hrSystemUptime OBJECT-TYPE
    SYNTAX     TimeTicks
    MAX-ACCESS read-only
    STATUS     current
    DESCRIPTION
        &#34;The amount of time since this host was last
        initialized.  Note that this is different from
        sysUpTime in the SNMPv2-MIB [RFC1907] because
        sysUpTime is the uptime of the network management
        portion of the system.&#34;
    ::= { hrSystem 1 }
</code></pre>

<p>The <a href="https://man.openbsd.org/snmpctl.8">snmpctl</a> command is:</p>

<pre><code>$ snmpctl snmp get &#60;host&#62; community &#60;string&#62; oid hrSystemUptime.0 
0=15259107187
</code></pre>

<p>In order to get anything that resembles time we can read there are a number of calculations that need to happen.</p>

<pre><code>15259107187 &#47; 8640000 = days (+remainder) = 176.6107855324074
0.6107855324074 * 24 = hours (+remainder) = 14.65885277777778
0.65885277777778 * 60 = minutes (+remainder) = 39.53116666666667
0.53116666666667 * 60 = seconds.milliseconds = 31.87
</code></pre>

<p>Together with <a href="https://twitter.com/romanzolotarev">Roman Zolotarev</a> we came up with the following part of the script:</p>

<pre><code>TICKS=$(snmpctl snmp get ${HOST} oid hrSystemUptime.0 | cut -d= -f2)
DAYS=$(echo &#34;${TICKS}&#47;8640000&#34; | bc -l)
HOURS=$(echo &#34;0.${DAYS##*.} * 24&#34; | bc -l)
MINUTES=$(echo &#34;0.${HOURS##*.} * 60&#34; | bc -l)
SECS=$(echo &#34;0.${MINUTES##*.} * 60&#34; | bc -l)
test -n &#34;$DAYS&#34; &#38;&#38; printf &#39;%s days, &#39; &#34;${DAYS%.*}&#34;
printf &#39;%02d:%02d:%02d\n&#39; &#34;${HOURS%.*}&#34; &#34;${MINUTES%.*}&#34; &#34;${SECS%.*}&#34;
</code></pre>

<p>Which results in <code>176 days, 14:39:31</code></p>

<p>The last part which MRTG expects is the hostname. This can be collected with:</p>

<pre><code>snmpctl snmp get ${HOST} oid sysName.0 | cut -d= -f2 | tr -d &#39;&#34;&#39;
</code></pre>

<p>All done!</p>

<p>What <a href="https://oss.oetiker.ch/mrtg/">MRTG</a> gets from the script is something like:</p>

<pre><code>3.50
3.50
138 days, 02:37:03
server1.openbsd.amsterdam
</code></pre>

<p>The complete script can be found in our <a href="https://git.high5.nl/mrtg">Git Repository</a>.</p>

<p>You can follow us on <a href="https://twitter.com/@OpenBSDAms">Twitter</a> and <a href="https://bsd.network/@OpenBSDAms">Mastodon</a>.</p>
<p class="footer f7 mt4">
&copy; 2018&ndash;2020 OpenBSD Amsterdam is a project of <a href="https://high5.nl/">High5!</a>
</body>
</html>
